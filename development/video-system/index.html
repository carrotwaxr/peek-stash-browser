<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Modern web application for browsing and streaming Stash media content with real-time HLS transcoding"><meta name=author content=carrotwaxr><link href=https://carrotwaxr.github.io/peek-stash-browser/development/video-system/ rel=canonical><link href=../architecture/ rel=prev><link href=../api-reference/ rel=next><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.22"><title>Video System - Peek Stash Browser</title><link rel=stylesheet href=../../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#video-system-architecture class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Peek Stash Browser" class="md-header__button md-logo" aria-label="Peek Stash Browser" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Peek Stash Browser </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Video System </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/carrotwaxr/peek-stash-browser title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> carrotwaxr/peek-stash-browser </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/installation/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../user-guide/video-playback/ class=md-tabs__link> User Guide </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../setup/ class=md-tabs__link> Development </a> </li> <li class=md-tabs__item> <a href=../../deployment/docker/ class=md-tabs__link> Deployment </a> </li> <li class=md-tabs__item> <a href=../../reference/troubleshooting/ class=md-tabs__link> Reference </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Peek Stash Browser" class="md-nav__button md-logo" aria-label="Peek Stash Browser" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> Peek Stash Browser </label> <div class=md-nav__source> <a href=https://github.com/carrotwaxr/peek-stash-browser title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> carrotwaxr/peek-stash-browser </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/quick-start/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/video-playback/ class=md-nav__link> <span class=md-ellipsis> Video Playback </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/watch-history/ class=md-nav__link> <span class=md-ellipsis> Watch History </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/playlists/ class=md-nav__link> <span class=md-ellipsis> Playlists </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/search-browse/ class=md-nav__link> <span class=md-ellipsis> Search & Browse </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/settings/ class=md-nav__link> <span class=md-ellipsis> Settings </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../setup/ class=md-nav__link> <span class=md-ellipsis> Setup </span> </a> </li> <li class=md-nav__item> <a href=../architecture/ class=md-nav__link> <span class=md-ellipsis> Architecture </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Video System </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Video System </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#transcoding-manager class=md-nav__link> <span class=md-ellipsis> Transcoding Manager </span> </a> <nav class=md-nav aria-label="Transcoding Manager"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#session-architecture class=md-nav__link> <span class=md-ellipsis> Session Architecture </span> </a> </li> <li class=md-nav__item> <a href=#quality-presets class=md-nav__link> <span class=md-ellipsis> Quality Presets </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ffmpeg-integration class=md-nav__link> <span class=md-ellipsis> FFmpeg Integration </span> </a> <nav class=md-nav aria-label="FFmpeg Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#hls-generation-command class=md-nav__link> <span class=md-ellipsis> HLS Generation Command </span> </a> </li> <li class=md-nav__item> <a href=#encoding-parameters class=md-nav__link> <span class=md-ellipsis> Encoding Parameters </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#session-lifecycle class=md-nav__link> <span class=md-ellipsis> Session Lifecycle </span> </a> <nav class=md-nav aria-label="Session Lifecycle"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-session-creation class=md-nav__link> <span class=md-ellipsis> 1. Session Creation </span> </a> </li> <li class=md-nav__item> <a href=#2-ffmpeg-process-startup class=md-nav__link> <span class=md-ellipsis> 2. FFmpeg Process Startup </span> </a> </li> <li class=md-nav__item> <a href=#3-hls-playlist-serving class=md-nav__link> <span class=md-ellipsis> 3. HLS Playlist Serving </span> </a> </li> <li class=md-nav__item> <a href=#4-segment-delivery class=md-nav__link> <span class=md-ellipsis> 4. Segment Delivery </span> </a> </li> <li class=md-nav__item> <a href=#5-session-cleanup class=md-nav__link> <span class=md-ellipsis> 5. Session Cleanup </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#seeking-and-session-reuse class=md-nav__link> <span class=md-ellipsis> Seeking and Session Reuse </span> </a> <nav class=md-nav aria-label="Seeking and Session Reuse"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#smart-seeking-strategy class=md-nav__link> <span class=md-ellipsis> Smart Seeking Strategy </span> </a> </li> <li class=md-nav__item> <a href=#segment-preservation class=md-nav__link> <span class=md-ellipsis> Segment Preservation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#videojs-configuration class=md-nav__link> <span class=md-ellipsis> Video.js Configuration </span> </a> <nav class=md-nav aria-label="Video.js Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#player-setup class=md-nav__link> <span class=md-ellipsis> Player Setup </span> </a> </li> <li class=md-nav__item> <a href=#loading-hls-source class=md-nav__link> <span class=md-ellipsis> Loading HLS Source </span> </a> </li> <li class=md-nav__item> <a href=#quality-selector class=md-nav__link> <span class=md-ellipsis> Quality Selector </span> </a> </li> <li class=md-nav__item> <a href=#event-handling class=md-nav__link> <span class=md-ellipsis> Event Handling </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#path-translation class=md-nav__link> <span class=md-ellipsis> Path Translation </span> </a> </li> <li class=md-nav__item> <a href=#performance-optimization class=md-nav__link> <span class=md-ellipsis> Performance Optimization </span> </a> <nav class=md-nav aria-label="Performance Optimization"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#encoding-performance class=md-nav__link> <span class=md-ellipsis> Encoding Performance </span> </a> </li> <li class=md-nav__item> <a href=#network-performance class=md-nav__link> <span class=md-ellipsis> Network Performance </span> </a> </li> <li class=md-nav__item> <a href=#storage-considerations class=md-nav__link> <span class=md-ellipsis> Storage Considerations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#common-issues class=md-nav__link> <span class=md-ellipsis> Common Issues </span> </a> </li> <li class=md-nav__item> <a href=#debug-logging class=md-nav__link> <span class=md-ellipsis> Debug Logging </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> </a> </li> <li class=md-nav__item> <a href=../testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Deployment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../deployment/docker/ class=md-nav__link> <span class=md-ellipsis> Docker </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/unraid/ class=md-nav__link> <span class=md-ellipsis> unRAID </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/environment/ class=md-nav__link> <span class=md-ellipsis> Environment Variables </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/build-checklist/ class=md-nav__link> <span class=md-ellipsis> Build Checklist </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> <li class=md-nav__item> <a href=../../reference/performance/ class=md-nav__link> <span class=md-ellipsis> Performance Tips </span> </a> </li> <li class=md-nav__item> <a href=../../reference/security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class=md-nav__item> <a href=../../reference/faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#transcoding-manager class=md-nav__link> <span class=md-ellipsis> Transcoding Manager </span> </a> <nav class=md-nav aria-label="Transcoding Manager"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#session-architecture class=md-nav__link> <span class=md-ellipsis> Session Architecture </span> </a> </li> <li class=md-nav__item> <a href=#quality-presets class=md-nav__link> <span class=md-ellipsis> Quality Presets </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ffmpeg-integration class=md-nav__link> <span class=md-ellipsis> FFmpeg Integration </span> </a> <nav class=md-nav aria-label="FFmpeg Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#hls-generation-command class=md-nav__link> <span class=md-ellipsis> HLS Generation Command </span> </a> </li> <li class=md-nav__item> <a href=#encoding-parameters class=md-nav__link> <span class=md-ellipsis> Encoding Parameters </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#session-lifecycle class=md-nav__link> <span class=md-ellipsis> Session Lifecycle </span> </a> <nav class=md-nav aria-label="Session Lifecycle"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-session-creation class=md-nav__link> <span class=md-ellipsis> 1. Session Creation </span> </a> </li> <li class=md-nav__item> <a href=#2-ffmpeg-process-startup class=md-nav__link> <span class=md-ellipsis> 2. FFmpeg Process Startup </span> </a> </li> <li class=md-nav__item> <a href=#3-hls-playlist-serving class=md-nav__link> <span class=md-ellipsis> 3. HLS Playlist Serving </span> </a> </li> <li class=md-nav__item> <a href=#4-segment-delivery class=md-nav__link> <span class=md-ellipsis> 4. Segment Delivery </span> </a> </li> <li class=md-nav__item> <a href=#5-session-cleanup class=md-nav__link> <span class=md-ellipsis> 5. Session Cleanup </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#seeking-and-session-reuse class=md-nav__link> <span class=md-ellipsis> Seeking and Session Reuse </span> </a> <nav class=md-nav aria-label="Seeking and Session Reuse"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#smart-seeking-strategy class=md-nav__link> <span class=md-ellipsis> Smart Seeking Strategy </span> </a> </li> <li class=md-nav__item> <a href=#segment-preservation class=md-nav__link> <span class=md-ellipsis> Segment Preservation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#videojs-configuration class=md-nav__link> <span class=md-ellipsis> Video.js Configuration </span> </a> <nav class=md-nav aria-label="Video.js Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#player-setup class=md-nav__link> <span class=md-ellipsis> Player Setup </span> </a> </li> <li class=md-nav__item> <a href=#loading-hls-source class=md-nav__link> <span class=md-ellipsis> Loading HLS Source </span> </a> </li> <li class=md-nav__item> <a href=#quality-selector class=md-nav__link> <span class=md-ellipsis> Quality Selector </span> </a> </li> <li class=md-nav__item> <a href=#event-handling class=md-nav__link> <span class=md-ellipsis> Event Handling </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#path-translation class=md-nav__link> <span class=md-ellipsis> Path Translation </span> </a> </li> <li class=md-nav__item> <a href=#performance-optimization class=md-nav__link> <span class=md-ellipsis> Performance Optimization </span> </a> <nav class=md-nav aria-label="Performance Optimization"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#encoding-performance class=md-nav__link> <span class=md-ellipsis> Encoding Performance </span> </a> </li> <li class=md-nav__item> <a href=#network-performance class=md-nav__link> <span class=md-ellipsis> Network Performance </span> </a> </li> <li class=md-nav__item> <a href=#storage-considerations class=md-nav__link> <span class=md-ellipsis> Storage Considerations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#common-issues class=md-nav__link> <span class=md-ellipsis> Common Issues </span> </a> </li> <li class=md-nav__item> <a href=#debug-logging class=md-nav__link> <span class=md-ellipsis> Debug Logging </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=video-system-architecture>Video System Architecture<a class=headerlink href=#video-system-architecture title="Permanent link">&para;</a></h1> <p>This document provides comprehensive details about Peek's video transcoding and streaming system, including FFmpeg integration, HLS streaming, and Video.js configuration.</p> <h2 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h2> <p>Peek uses a session-based transcoding system powered by FFmpeg to deliver adaptive HLS (HTTP Live Streaming) video with multiple quality levels. Videos are transcoded on-demand when users play them, with intelligent session management for seeking and quality switching.</p> <h2 id=transcoding-manager>Transcoding Manager<a class=headerlink href=#transcoding-manager title="Permanent link">&para;</a></h2> <p>The <code>TranscodingManager</code> service (<code>server/src/services/TranscodingManager.ts</code>) is the core of the video system, managing FFmpeg processes and HLS session lifecycle.</p> <h3 id=session-architecture>Session Architecture<a class=headerlink href=#session-architecture title="Permanent link">&para;</a></h3> <p>Each video playback session is represented by a unique session object:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kd>interface</span><span class=w> </span><span class=nx>TranscodingSession</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>  </span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w>        </span><span class=c1>// Unique identifier (UUID)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>  </span><span class=nx>sceneId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w>          </span><span class=c1>// Source video ID from Stash</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>  </span><span class=nx>startTime</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>;</span><span class=w>        </span><span class=c1>// Seek position in seconds</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>  </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w>           </span><span class=c1>// User who initiated session</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>  </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>SessionStatus</span><span class=p>;</span><span class=w>    </span><span class=c1>// Current session status</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>  </span><span class=nx>qualities</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>[];</span><span class=w>      </span><span class=c1>// Available quality levels [&#39;720p&#39;, &#39;480p&#39;, &#39;360p&#39;]</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>  </span><span class=nx>processes</span><span class=o>:</span><span class=w> </span><span class=kt>Map</span><span class=o>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>ChildProcess</span><span class=o>&gt;</span><span class=p>;</span><span class=w>  </span><span class=c1>// FFmpeg processes per quality</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>  </span><span class=nx>lastAccess</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span><span class=w>         </span><span class=c1>// For cleanup tracking</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>  </span><span class=nx>outputDir</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w>        </span><span class=c1>// Temporary file directory</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>  </span><span class=nx>scene?</span><span class=o>:</span><span class=w> </span><span class=kt>Scene</span><span class=p>;</span><span class=w>            </span><span class=c1>// Cached scene metadata from Stash</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=p>}</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=kr>type</span><span class=w> </span><span class=nx>SessionStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;starting&#39;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s1>&#39;active&#39;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span></code></pre></div> <h3 id=quality-presets>Quality Presets<a class=headerlink href=#quality-presets title="Permanent link">&para;</a></h3> <p>Peek offers three quality levels with optimized encoding parameters:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kd>const</span><span class=w> </span><span class=nx>QUALITY_PRESETS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>  </span><span class=s1>&#39;720p&#39;</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=nx>video</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>      </span><span class=nx>resolution</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1280:720&#39;</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>      </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;2500k&#39;</span><span class=p>,</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>      </span><span class=nx>maxrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;2800k&#39;</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>      </span><span class=nx>bufsize</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;5000k&#39;</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span><span class=nx>audio</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>      </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;128k&#39;</span><span class=p>,</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>      </span><span class=nx>sampleRate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;48000&#39;</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>  </span><span class=s1>&#39;480p&#39;</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=w>    </span><span class=nx>video</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=w>      </span><span class=nx>resolution</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;854:480&#39;</span><span class=p>,</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=w>      </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1000k&#39;</span><span class=p>,</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=w>      </span><span class=nx>maxrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1200k&#39;</span><span class=p>,</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=w>      </span><span class=nx>bufsize</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;2000k&#39;</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a><span class=w>    </span><span class=nx>audio</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=w>      </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;96k&#39;</span><span class=p>,</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=w>      </span><span class=nx>sampleRate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;44100&#39;</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=w>  </span><span class=s1>&#39;360p&#39;</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a><span class=w>    </span><span class=nx>video</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a><span class=w>      </span><span class=nx>resolution</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;640:360&#39;</span><span class=p>,</span>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a><span class=w>      </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;500k&#39;</span><span class=p>,</span>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a><span class=w>      </span><span class=nx>maxrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;600k&#39;</span><span class=p>,</span>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a><span class=w>      </span><span class=nx>bufsize</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1000k&#39;</span>
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a><span class=w>    </span><span class=nx>audio</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a><span class=w>      </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;64k&#39;</span><span class=p>,</span>
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a><span class=w>      </span><span class=nx>sampleRate</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;44100&#39;</span>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a><span class=p>};</span>
</span></code></pre></div> <h2 id=ffmpeg-integration>FFmpeg Integration<a class=headerlink href=#ffmpeg-integration title="Permanent link">&para;</a></h2> <h3 id=hls-generation-command>HLS Generation Command<a class=headerlink href=#hls-generation-command title="Permanent link">&para;</a></h3> <p>Peek uses FFmpeg to generate HLS playlists and segments with adaptive quality:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>ffmpeg<span class=w> </span>-ss<span class=w> </span><span class=si>${</span><span class=nv>startTime</span><span class=si>}</span><span class=w> </span>-i<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>inputFile</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>  </span>-c:v<span class=w> </span>libx264<span class=w> </span>-preset<span class=w> </span>fast<span class=w> </span>-crf<span class=w> </span><span class=m>23</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span>-c:a<span class=w> </span>aac<span class=w> </span>-strict<span class=w> </span>experimental<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>  </span>-f<span class=w> </span>hls<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>  </span>-hls_time<span class=w> </span><span class=m>4</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>  </span>-hls_list_size<span class=w> </span><span class=m>0</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>  </span>-hls_segment_type<span class=w> </span>mpegts<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>  </span>-master_pl_name<span class=w> </span>master.m3u8<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>  </span>-var_stream_map<span class=w> </span><span class=s2>&quot;v:0,a:0 v:1,a:1 v:2,a:2&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>  </span>-hls_segment_filename<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>outputDir</span><span class=si>}</span><span class=s2>/stream_%v/segment_%03d.ts&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>  </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>outputDir</span><span class=si>}</span><span class=s2>/stream_%v/playlist.m3u8&quot;</span>
</span></code></pre></div> <p><strong>Key FFmpeg Options</strong>:</p> <table> <thead> <tr> <th>Option</th> <th>Purpose</th> </tr> </thead> <tbody> <tr> <td><code>-ss ${startTime}</code></td> <td>Seek to start position (before input for efficiency)</td> </tr> <tr> <td><code>-i "${inputFile}"</code></td> <td>Input video file</td> </tr> <tr> <td><code>-c:v libx264</code></td> <td>H.264 video codec</td> </tr> <tr> <td><code>-preset fast</code></td> <td>Encoding speed/quality tradeoff</td> </tr> <tr> <td><code>-crf 23</code></td> <td>Constant Rate Factor (quality level, lower = better)</td> </tr> <tr> <td><code>-c:a aac</code></td> <td>AAC audio codec</td> </tr> <tr> <td><code>-f hls</code></td> <td>HLS output format</td> </tr> <tr> <td><code>-hls_time 4</code></td> <td>4-second segment duration</td> </tr> <tr> <td><code>-hls_list_size 0</code></td> <td>Keep all segments in playlist (VOD mode)</td> </tr> <tr> <td><code>-master_pl_name</code></td> <td>Master playlist filename</td> </tr> <tr> <td><code>-var_stream_map</code></td> <td>Map video/audio streams to quality variants</td> </tr> <tr> <td><code>-hls_segment_filename</code></td> <td>Template for segment files</td> </tr> </tbody> </table> <h3 id=encoding-parameters>Encoding Parameters<a class=headerlink href=#encoding-parameters title="Permanent link">&para;</a></h3> <p><strong>Video Encoding</strong>: - <strong>Codec</strong>: H.264 (libx264) for broad compatibility - <strong>Preset</strong>: <code>fast</code> balances encoding speed and quality - <strong>CRF</strong>: 23 (good quality, reasonable file size) - <strong>Keyframe interval</strong>: Every 2 seconds for seekability</p> <p><strong>Audio Encoding</strong>: - <strong>Codec</strong>: AAC for compatibility - <strong>Bitrate</strong>: 128k (720p), 96k (480p), 64k (360p) - <strong>Sample rate</strong>: 48kHz (720p), 44.1kHz (480p/360p)</p> <p><strong>HLS Settings</strong>: - <strong>Segment duration</strong>: 4 seconds (balance between latency and efficiency) - <strong>Playlist type</strong>: VOD (complete playlist with all segments) - <strong>Segment format</strong>: MPEG-TS for compatibility</p> <h2 id=session-lifecycle>Session Lifecycle<a class=headerlink href=#session-lifecycle title="Permanent link">&para;</a></h2> <h3 id=1-session-creation>1. Session Creation<a class=headerlink href=#1-session-creation title="Permanent link">&para;</a></h3> <p>When a user requests video playback:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>transcodingManager</span><span class=p>.</span><span class=nx>createSession</span><span class=p>({</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>  </span><span class=nx>sceneId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;12345&#39;</span><span class=p>,</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>  </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user-uuid&#39;</span><span class=p>,</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=nx>startTime</span><span class=o>:</span><span class=w> </span><span class=kt>120</span><span class=p>,</span><span class=w>  </span><span class=c1>// Start at 2 minutes</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>  </span><span class=nx>qualities</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;720p&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;480p&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;360p&#39;</span><span class=p>]</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=p>});</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=c1>// Returns:</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=p>{</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>  </span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;session-uuid&#39;</span><span class=p>,</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>  </span><span class=nx>masterPlaylistUrl</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/api/video/session/session-uuid/master.m3u8&#39;</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=p>}</span>
</span></code></pre></div> <h3 id=2-ffmpeg-process-startup>2. FFmpeg Process Startup<a class=headerlink href=#2-ffmpeg-process-startup title="Permanent link">&para;</a></h3> <p>For each quality level, Peek spawns an FFmpeg process:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kd>const</span><span class=w> </span><span class=nx>ffmpegProcess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>spawn</span><span class=p>(</span><span class=s1>&#39;ffmpeg&#39;</span><span class=p>,</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>  </span><span class=s1>&#39;-ss&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>startTime</span><span class=p>.</span><span class=nx>toString</span><span class=p>(),</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>  </span><span class=s1>&#39;-i&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>videoPath</span><span class=p>,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>  </span><span class=c1>// ... encoding parameters</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>  </span><span class=s1>&#39;-hls_segment_filename&#39;</span><span class=p>,</span><span class=w> </span><span class=sb>`</span><span class=si>${</span><span class=nx>outputDir</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>quality</span><span class=si>}</span><span class=sb>/segment_%03d.ts`</span><span class=p>,</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=sb>`</span><span class=si>${</span><span class=nx>outputDir</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>quality</span><span class=si>}</span><span class=sb>/playlist.m3u8`</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=p>]);</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=c1>// Monitor process output</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=nx>ffmpegProcess</span><span class=p>.</span><span class=nx>stderr</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>  </span><span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;FFmpeg output&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>quality</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>data.toString</span><span class=p>()</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=p>});</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=nx>ffmpegProcess</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;exit&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>code</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>code</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;completed&#39;</span><span class=p>;</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>    </span><span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;FFmpeg process failed&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>quality</span><span class=p>,</span><span class=w> </span><span class=nx>exitCode</span><span class=o>:</span><span class=w> </span><span class=kt>code</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=p>});</span>
</span></code></pre></div> <h3 id=3-hls-playlist-serving>3. HLS Playlist Serving<a class=headerlink href=#3-hls-playlist-serving title="Permanent link">&para;</a></h3> <p><strong>Master Playlist</strong> (<code>/api/video/session/:sessionId/master.m3u8</code>):</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>#EXTM3U
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>#EXT-X-VERSION:6
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>#EXT-X-STREAM-INF:BANDWIDTH=2500000,RESOLUTION=1280x720
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>stream_0/playlist.m3u8
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>#EXT-X-STREAM-INF:BANDWIDTH=1000000,RESOLUTION=854x480
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>stream_1/playlist.m3u8
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>#EXT-X-STREAM-INF:BANDWIDTH=500000,RESOLUTION=640x360
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>stream_2/playlist.m3u8
</span></code></pre></div> <p><strong>Quality Playlist</strong> (<code>/api/video/session/:sessionId/720p/playlist.m3u8</code>):</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>#EXTM3U
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>#EXT-X-VERSION:3
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>#EXT-X-TARGETDURATION:4
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>#EXT-X-MEDIA-SEQUENCE:0
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>#EXT-X-PLAYLIST-TYPE:VOD
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>#EXTINF:4.000000,
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>segment_000.ts
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>#EXTINF:4.000000,
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>segment_001.ts
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>#EXTINF:4.000000,
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>segment_002.ts
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a># ... continues for all segments
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>#EXT-X-ENDLIST
</span></code></pre></div> <h3 id=4-segment-delivery>4. Segment Delivery<a class=headerlink href=#4-segment-delivery title="Permanent link">&para;</a></h3> <p>Video segments are served as they're generated by FFmpeg:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/video/session/:sessionId/:quality/segment_:num.ts&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>quality</span><span class=p>,</span><span class=w> </span><span class=nx>num</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>transcodingManager</span><span class=p>.</span><span class=nx>getSession</span><span class=p>(</span><span class=nx>sessionId</span><span class=p>);</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>session</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>404</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Session not found&#39;</span><span class=p>);</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>segmentPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>outputDir</span><span class=p>,</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>    </span><span class=nx>quality</span><span class=p>,</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>    </span><span class=sb>`segment_</span><span class=si>${</span><span class=nx>num</span><span class=p>.</span><span class=nx>padStart</span><span class=p>(</span><span class=mf>3</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0&#39;</span><span class=p>)</span><span class=si>}</span><span class=sb>.ts`</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=w>  </span><span class=c1>// Wait for segment to be generated if not ready</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>waitForSegment</span><span class=p>(</span><span class=nx>segmentPath</span><span class=p>);</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=w>  </span><span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=nx>segmentPath</span><span class=p>);</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=p>});</span>
</span></code></pre></div> <h3 id=5-session-cleanup>5. Session Cleanup<a class=headerlink href=#5-session-cleanup title="Permanent link">&para;</a></h3> <p>Sessions are automatically cleaned up after inactivity:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kd>const</span><span class=w> </span><span class=nx>CLEANUP_INTERVAL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>;</span><span class=w>  </span><span class=c1>// 30 minutes</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>session</span><span class=p>]</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>sessions</span><span class=p>.</span><span class=nx>entries</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>inactiveTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>now</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>lastAccess</span><span class=p>.</span><span class=nx>getTime</span><span class=p>();</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>inactiveTime</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nx>CLEANUP_INTERVAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>      </span><span class=c1>// Kill FFmpeg processes</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>      </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>process</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>processes</span><span class=p>.</span><span class=nx>values</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>        </span><span class=nx>process</span><span class=p>.</span><span class=nx>kill</span><span class=p>(</span><span class=s1>&#39;SIGTERM&#39;</span><span class=p>);</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>      </span><span class=c1>// Delete temporary files</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>rmSync</span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>outputDir</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>recursive</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span><span class=w> </span><span class=nx>force</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>      </span><span class=c1>// Remove session</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>      </span><span class=nx>sessions</span><span class=p>.</span><span class=ow>delete</span><span class=p>(</span><span class=nx>sessionId</span><span class=p>);</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=w>      </span><span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>&#39;Session cleaned up&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>inactiveTime</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=p>},</span><span class=w> </span><span class=mf>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>);</span><span class=w>  </span><span class=c1>// Check every 5 minutes</span>
</span></code></pre></div> <h2 id=seeking-and-session-reuse>Seeking and Session Reuse<a class=headerlink href=#seeking-and-session-reuse title="Permanent link">&para;</a></h2> <h3 id=smart-seeking-strategy>Smart Seeking Strategy<a class=headerlink href=#smart-seeking-strategy title="Permanent link">&para;</a></h3> <p>When a user seeks within a video, Peek decides whether to: 1. <strong>Reuse existing session</strong> (if seeking nearby) 2. <strong>Restart FFmpeg</strong> (if seeking far away)</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kd>const</span><span class=w> </span><span class=nx>SEEK_THRESHOLD</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>30</span><span class=p>;</span><span class=w>  </span><span class=c1>// seconds</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>handleSeek</span><span class=p>(</span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>newTime</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getSession</span><span class=p>(</span><span class=nx>sessionId</span><span class=p>);</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>timeDiff</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>abs</span><span class=p>(</span><span class=nx>newTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>startTime</span><span class=p>);</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>timeDiff</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nx>SEEK_THRESHOLD</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>    </span><span class=c1>// Seeking nearby - keep existing session</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>    </span><span class=c1>// Video.js will navigate to correct segment</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>reused</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>    </span><span class=c1>// Seeking far - create new session from new position</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>createSession</span><span class=p>({</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>      </span><span class=nx>sceneId</span><span class=o>:</span><span class=w> </span><span class=kt>session.sceneId</span><span class=p>,</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>      </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>session.userId</span><span class=p>,</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>      </span><span class=nx>startTime</span><span class=o>:</span><span class=w> </span><span class=kt>newTime</span><span class=p>,</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>      </span><span class=nx>qualities</span><span class=o>:</span><span class=w> </span><span class=kt>session.qualities</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=p>}</span>
</span></code></pre></div> <h3 id=segment-preservation>Segment Preservation<a class=headerlink href=#segment-preservation title="Permanent link">&para;</a></h3> <p>When restarting a session from a new position, already-transcoded segments are preserved:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>restartSession</span><span class=p>(</span><span class=nx>session</span><span class=o>:</span><span class=w> </span><span class=kt>TranscodingSession</span><span class=p>,</span><span class=w> </span><span class=nx>newStartTime</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>  </span><span class=c1>// Kill existing FFmpeg processes</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>process</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>processes</span><span class=p>.</span><span class=nx>values</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=nx>process</span><span class=p>.</span><span class=nx>kill</span><span class=p>(</span><span class=s1>&#39;SIGTERM&#39;</span><span class=p>);</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>  </span><span class=c1>// Keep existing output directory with transcoded segments</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>preservedDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>outputDir</span><span class=p>;</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>  </span><span class=c1>// Start new FFmpeg from new position</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>  </span><span class=c1>// Segments will be created with new numbering</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>  </span><span class=c1>// Old segments remain available for seeking back</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>  </span><span class=nx>session</span><span class=p>.</span><span class=nx>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>newStartTime</span><span class=p>;</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>  </span><span class=nx>session</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;starting&#39;</span><span class=p>;</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>startFFmpegProcesses</span><span class=p>(</span><span class=nx>session</span><span class=p>);</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=p>}</span>
</span></code></pre></div> <h2 id=videojs-configuration>Video.js Configuration<a class=headerlink href=#videojs-configuration title="Permanent link">&para;</a></h2> <h3 id=player-setup>Player Setup<a class=headerlink href=#player-setup title="Permanent link">&para;</a></h3> <p>Peek uses Video.js 8 with custom configuration for optimal HLS playback:</p> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>import</span><span class=w> </span><span class=nx>videojs</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;video.js&#39;</span><span class=p>;</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=k>import</span><span class=w> </span><span class=s1>&#39;video.js/dist/video-js.css&#39;</span><span class=p>;</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=kd>const</span><span class=w> </span><span class=nx>videoJsOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>  </span><span class=nx>autoplay</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>  </span><span class=nx>controls</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>  </span><span class=nx>responsive</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>  </span><span class=nx>fluid</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>  </span><span class=nx>playbackRates</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=mf>0.5</span><span class=p>,</span><span class=w> </span><span class=mf>1</span><span class=p>,</span><span class=w> </span><span class=mf>1.25</span><span class=p>,</span><span class=w> </span><span class=mf>1.5</span><span class=p>,</span><span class=w> </span><span class=mf>2</span><span class=p>],</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>  </span><span class=nx>html5</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>    </span><span class=nx>vhs</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>      </span><span class=c1>// Force VHS for all browsers except Safari</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>      </span><span class=nx>overrideNative</span><span class=o>:</span><span class=w> </span><span class=o>!</span><span class=nx>videojs</span><span class=p>.</span><span class=nx>browser</span><span class=p>.</span><span class=nx>IS_SAFARI</span><span class=p>,</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>      </span><span class=c1>// VOD-specific settings</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>      </span><span class=nx>enableLowInitialPlaylist</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>  </span><span class=c1>// Don&#39;t treat as live</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>      </span><span class=nx>smoothQualityChange</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>        </span><span class=c1>// Smooth quality switching</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>      </span><span class=nx>useBandwidthFromLocalStorage</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>      </span><span class=nx>limitRenditionByPlayerDimensions</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>      </span><span class=nx>allowSeeksWithinUnsafeLiveWindow</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=w>      </span><span class=nx>handlePartialData</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=w>      </span><span class=c1>// Bandwidth estimation</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=w>      </span><span class=nx>bandwidth</span><span class=o>:</span><span class=w> </span><span class=mf>4194304</span><span class=p>,</span><span class=w>  </span><span class=c1>// 4 Mbps initial estimate</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=w>      </span><span class=nx>enableLowInitialPlaylist</span><span class=o>:</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=w>    </span><span class=c1>// Disable native tracks for consistent behavior</span>
</span><span id=__span-11-30><a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=w>    </span><span class=nx>nativeAudioTracks</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
</span><span id=__span-11-31><a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a><span class=w>    </span><span class=nx>nativeVideoTracks</span><span class=o>:</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-11-32><a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-11-33><a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a>
</span><span id=__span-11-34><a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a><span class=w>  </span><span class=nx>plugins</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-35><a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a><span class=w>    </span><span class=nx>qualityLevels</span><span class=o>:</span><span class=w> </span><span class=p>{}</span><span class=w>  </span><span class=c1>// Enable quality level selection</span>
</span><span id=__span-11-36><a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-11-37><a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a><span class=p>};</span>
</span><span id=__span-11-38><a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a>
</span><span id=__span-11-39><a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a><span class=kd>const</span><span class=w> </span><span class=nx>player</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>videojs</span><span class=p>(</span><span class=s1>&#39;video-player&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>videoJsOptions</span><span class=p>);</span>
</span></code></pre></div> <h3 id=loading-hls-source>Loading HLS Source<a class=headerlink href=#loading-hls-source title="Permanent link">&para;</a></h3> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=nx>player</span><span class=p>.</span><span class=nx>src</span><span class=p>({</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>  </span><span class=nx>src</span><span class=o>:</span><span class=w> </span><span class=sb>`/api/video/session/</span><span class=si>${</span><span class=nx>sessionId</span><span class=si>}</span><span class=sb>/master.m3u8`</span><span class=p>,</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>  </span><span class=nx>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;application/x-mpegURL&#39;</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=p>});</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=c1>// Wait for source to load</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=nx>player</span><span class=p>.</span><span class=nx>ready</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>  </span><span class=nx>player</span><span class=p>.</span><span class=nx>play</span><span class=p>();</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=p>});</span>
</span></code></pre></div> <h3 id=quality-selector>Quality Selector<a class=headerlink href=#quality-selector title="Permanent link">&para;</a></h3> <p>Custom quality selector UI for user-controlled quality switching:</p> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=kd>const</span><span class=w> </span><span class=nx>qualityLevels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>player</span><span class=p>.</span><span class=nx>qualityLevels</span><span class=p>();</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=nx>qualityLevels</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;addqualitylevel&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>quality</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>qualityLevel</span><span class=p>;</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>  </span><span class=c1>// Add quality option to UI</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>  </span><span class=nx>addQualityOption</span><span class=p>({</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>    </span><span class=nx>height</span><span class=o>:</span><span class=w> </span><span class=nx>quality</span><span class=p>.</span><span class=nx>height</span><span class=p>,</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>    </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=nx>quality</span><span class=p>.</span><span class=nx>bitrate</span><span class=p>,</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>    </span><span class=nx>enabled</span><span class=o>:</span><span class=w> </span><span class=nx>quality</span><span class=p>.</span><span class=nx>enabled</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=p>});</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=kd>function</span><span class=w> </span><span class=nx>setQuality</span><span class=p>(</span><span class=nx>height</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>let</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nx>qualityLevels</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>level</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>qualityLevels</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>height</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;auto&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>      </span><span class=nx>level</span><span class=p>.</span><span class=nx>enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>  </span><span class=c1>// Enable all for auto</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>      </span><span class=nx>level</span><span class=p>.</span><span class=nx>enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=nx>level</span><span class=p>.</span><span class=nx>height</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>height</span><span class=p>);</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=p>}</span>
</span></code></pre></div> <h3 id=event-handling>Event Handling<a class=headerlink href=#event-handling title="Permanent link">&para;</a></h3> <div class="language-javascript highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1>// Track playback progress</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nx>player</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;timeupdate&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>currentTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>player</span><span class=p>.</span><span class=nx>currentTime</span><span class=p>();</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=nx>updateProgressBar</span><span class=p>(</span><span class=nx>currentTime</span><span class=p>);</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=p>});</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=c1>// Handle seeking</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=nx>player</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;seeking&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>seekTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>player</span><span class=p>.</span><span class=nx>currentTime</span><span class=p>();</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>  </span><span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;User seeking&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>seekTime</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=p>});</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=c1>// Handle quality changes</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=nx>qualityLevels</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;change&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>currentQuality</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>qualityLevels</span><span class=p>[</span><span class=nx>qualityLevels</span><span class=p>.</span><span class=nx>selectedIndex</span><span class=p>];</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>  </span><span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>&#39;Quality changed&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>    </span><span class=nx>height</span><span class=o>:</span><span class=w> </span><span class=nx>currentQuality</span><span class=p>.</span><span class=nx>height</span><span class=p>,</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>    </span><span class=nx>bitrate</span><span class=o>:</span><span class=w> </span><span class=nx>currentQuality</span><span class=p>.</span><span class=nx>bitrate</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=p>});</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=c1>// Handle errors</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=nx>player</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=w>  </span><span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Video playback error&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=w>    </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>,</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>    </span><span class=nx>message</span><span class=o>:</span><span class=w> </span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=w>  </span><span class=nx>showErrorMessage</span><span class=p>(</span><span class=s1>&#39;Video playback failed. Please try again.&#39;</span><span class=p>);</span>
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=p>});</span>
</span></code></pre></div> <h2 id=path-translation>Path Translation<a class=headerlink href=#path-translation title="Permanent link">&para;</a></h2> <p>Peek translates paths between Stash's internal Docker paths and Peek's mount points:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>translateStashPath</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./utils/pathMapping&#39;</span><span class=p>;</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=c1>// Stash reports: /data/scenes/video.mp4</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=c1>// Peek mounts media at: /app/media</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=kd>const</span><span class=w> </span><span class=nx>stashPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>scene</span><span class=p>.</span><span class=nx>files</span><span class=p>[</span><span class=mf>0</span><span class=p>].</span><span class=nx>path</span><span class=p>;</span><span class=w>  </span><span class=c1>// &quot;/data/scenes/video.mp4&quot;</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=kd>const</span><span class=w> </span><span class=nx>peekPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>translateStashPath</span><span class=p>(</span><span class=nx>stashPath</span><span class=p>);</span><span class=w>  </span><span class=c1>// &quot;/app/media/scenes/video.mp4&quot;</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=c1>// Start transcoding with translated path</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=k>await</span><span class=w> </span><span class=nx>transcodingManager</span><span class=p>.</span><span class=nx>createSession</span><span class=p>({</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>  </span><span class=nx>inputPath</span><span class=o>:</span><span class=w> </span><span class=kt>peekPath</span><span class=p>,</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>  </span><span class=c1>// ... other options</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=p>});</span>
</span></code></pre></div> <p><strong>Configuration</strong>: - <code>STASH_INTERNAL_PATH</code>: Path prefix Stash uses internally (default: <code>/data</code>) - <code>STASH_MEDIA_PATH</code>: Where Peek accesses Stash's media (default: <code>/app/media</code>)</p> <h2 id=performance-optimization>Performance Optimization<a class=headerlink href=#performance-optimization title="Permanent link">&para;</a></h2> <h3 id=encoding-performance>Encoding Performance<a class=headerlink href=#encoding-performance title="Permanent link">&para;</a></h3> <p><strong>Fast Preset</strong>: Balances speed and quality - Suitable for real-time transcoding - 0.8x - 2.0x encoding speed on typical hardware</p> <p><strong>Seeking Optimization</strong>: <code>-ss</code> before <code>-i</code> for fast seeking - FFmpeg seeks in input file before decoding - Much faster than decoding then seeking</p> <p><strong>Segment Duration</strong>: 4 seconds - Good balance between latency and efficiency - Smaller segments = more overhead, lower latency - Larger segments = less overhead, higher latency</p> <h3 id=network-performance>Network Performance<a class=headerlink href=#network-performance title="Permanent link">&para;</a></h3> <p><strong>Adaptive Bitrate</strong>: Video.js automatically selects quality based on bandwidth</p> <p><strong>Quality Presets</strong>: - 720p @ 2.5 Mbps: Good for local networks, wired connections - 480p @ 1.0 Mbps: Good for WiFi, moderate bandwidth - 360p @ 500 Kbps: Good for mobile, low bandwidth</p> <p><strong>Segment Buffering</strong>: Video.js buffers 2-3 segments ahead</p> <h3 id=storage-considerations>Storage Considerations<a class=headerlink href=#storage-considerations title="Permanent link">&para;</a></h3> <p><strong>Temporary Storage</strong>: - Each session creates temporary files in <code>CONFIG_DIR/hls-cache</code> - Storage usage: ~50-100 MB per quality per minute of video - Automatic cleanup after 30 minutes of inactivity</p> <p><strong>Recommendations</strong>: - Use SSD for temporary storage (faster I/O) - Allocate 5-10 GB for <code>CONFIG_DIR</code> on busy servers - Monitor disk usage with cleanup scripts</p> <h2 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h2> <h3 id=common-issues>Common Issues<a class=headerlink href=#common-issues title="Permanent link">&para;</a></h3> <p><strong>Video Won't Play</strong>: 1. Check FFmpeg is installed: <code>ffmpeg -version</code> 2. Verify path mapping is correct (check logs for translated paths) 3. Check file permissions on media directory 4. Review FFmpeg errors in backend logs</p> <p><strong>Slow Transcoding</strong>: 1. Check CPU usage (FFmpeg is CPU-intensive) 2. Verify media is on local storage (not network share) 3. Consider reducing quality presets 4. Check I/O performance with <code>dd if=/app/media/file.mp4 of=/dev/null</code></p> <p><strong>Seeking Issues</strong>: 1. Check segment generation (are segments being created?) 2. Verify playlist is updated (check playlist.m3u8 content) 3. Review Video.js console logs for seeking errors 4. Check session is still active (not cleaned up)</p> <p><strong>Quality Switching Issues</strong>: 1. Verify all quality playlists are being generated 2. Check Video.js quality levels are being detected 3. Review network bandwidth estimation 4. Test with <code>setQuality()</code> function manually</p> <h3 id=debug-logging>Debug Logging<a class=headerlink href=#debug-logging title="Permanent link">&para;</a></h3> <p>Enable detailed logging for video system debugging:</p> <div class="language-typescript highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// Backend (server/utils/logger.ts)</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=nx>logger</span><span class=p>.</span><span class=nx>level</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=c1>// Frontend (Video.js)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=nx>videojs</span><span class=p>.</span><span class=nx>log</span><span class=p>.</span><span class=nx>level</span><span class=p>(</span><span class=s1>&#39;debug&#39;</span><span class=p>);</span>
</span></code></pre></div> <p><strong>Useful Log Messages</strong>: - <code>Session created</code>: New transcoding session started - <code>FFmpeg started</code>: FFmpeg process spawned for quality - <code>Segment completed</code>: HLS segment finished encoding - <code>Session cleaned up</code>: Inactive session removed - <code>Quality changed</code>: User switched quality level</p> <h2 id=next-steps>Next Steps<a class=headerlink href=#next-steps title="Permanent link">&para;</a></h2> <ul> <li><a href=../api-reference/ >API Reference</a> - Video streaming endpoints</li> <li><a href=../testing/ >Testing Guide</a> - Testing video functionality</li> <li><a href=../../reference/performance/ >Performance Tips</a> - Optimization strategies</li> </ul> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../architecture/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Architecture"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Architecture </div> </div> </a> <a href=../api-reference/ class="md-footer__link md-footer__link--next" aria-label="Next: API Reference"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> API Reference </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 carrotwaxr </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/carrotwaxr/peek-stash-browser target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://hub.docker.com/r/carrotwaxr/peek-stash-browser target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../javascripts/extra.js></script> </body> </html>