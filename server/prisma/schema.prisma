generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url = env("DATABASE_URL")
}

model User {
    id          Int         @id @default(autoincrement())
    username    String      @unique
    password    String      // Will be hashed
    role        UserRole    @default(USER)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    // User preferences
    preferredQuality    String?     @default("auto")    // "auto", "1080p", "720p", "480p", "360p"
    preferredPlaybackMode String?   @default("auto")    // "auto", "direct", "transcode"
    preferredPreviewQuality String? @default("sprite")  // "sprite", "webp", "mp4" - Card preview quality (sprite=low quality, webp/mp4=high quality with sprite fallback)
    enableCast         Boolean     @default(true)      // Enable Chromecast/AirPlay plugins
    theme              String?     @default("dark")    // "dark", "light", "purple", etc.
    carouselPreferences Json?       // Array of {id, enabled, order} for homepage carousels
    navPreferences     Json?       // Array of {id, enabled, order} for navigation menu items
    filterPresets      Json?       // Object with keys: scene, performer, studio, tag, group, gallery - each containing array of saved presets
    defaultFilterPresets Json?      // Object with keys: scene, performer, studio, tag, group, gallery - values are preset IDs

    // Watch history settings
    minimumPlayPercent Int         @default(20)        // Percent of video to watch before incrementing play_count (0-100)
    syncToStash        Boolean     @default(false)     // Admin-only: Sync this user's activity to Stash

    // Future features
    watchHistory WatchHistory[]
    playlists   Playlist[]
    customThemes CustomTheme[]

    // Per-user ratings and favorites
    sceneRatings     SceneRating[]
    performerRatings PerformerRating[]
    studioRatings    StudioRating[]
    tagRatings       TagRating[]
    galleryRatings   GalleryRating[]
    groupRatings     GroupRating[]

    // Content restrictions
    contentRestrictions UserContentRestriction[]
}

model WatchHistory {
    id              Int         @id @default(autoincrement())
    userId          Int
    sceneId         String      // Stash scene ID

    // Playback tracking (syncs with Stash)
    playCount       Int         @default(0)      // Number of 5+ minute sessions
    playDuration    Float       @default(0)      // Total seconds watched (cumulative across all sessions)
    resumeTime      Float?                       // Last playback position in seconds
    lastPlayedAt    DateTime?                    // Last time this scene was played

    // O Counter tracking (syncs with Stash)
    oCount          Int         @default(0)      // Total O counter increments
    oHistory        Json        @default("[]")   // Array of timestamp strings when O was incremented

    // Detailed play session history for analytics
    playHistory     Json        @default("[]")   // Array of {startTime, endTime, quality, duration, seekEvents: [{time, from, to}]}

    // Legacy fields (deprecated, use fields above)
    watchedAt       DateTime    @default(now())
    position        Int         @default(0)
    duration        Int?
    completed       Boolean     @default(false)

    user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, sceneId])
    @@index([userId])
    @@index([sceneId])
    @@index([lastPlayedAt])
}

model Playlist {
    id          Int         @id @default(autoincrement())
    name        String
    description String?
    userId      Int
    isPublic    Boolean     @default(false)
    shuffle     Boolean     @default(false)
    repeat      String      @default("none")  // "none", "all", "one"
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    items       PlaylistItem[]

    @@index([userId])
    @@index([updatedAt])
}

model PlaylistItem {
    id          Int         @id @default(autoincrement())
    playlistId  Int
    sceneId     String      // Stash scene ID
    position    Int         // Order in playlist
    addedAt     DateTime    @default(now())

    playlist    Playlist    @relation(fields: [playlistId], references: [id], onDelete: Cascade)

    @@unique([playlistId, sceneId])
    @@index([playlistId, position])
}

model CustomTheme {
    id          Int         @id @default(autoincrement())
    userId      Int
    name        String      // User-defined theme name (e.g., "My Purple Theme")
    config      Json        // Complete theme config: {mode, fonts, colors, accents, status}
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, name])
    @@index([userId])
}

model PathMapping {
    id          Int         @id @default(autoincrement())
    stashPath   String      // Path as reported by Stash (e.g., "/data", "C:\Videos")
    peekPath    String      // Path where Peek accesses the files (e.g., "/app/media")
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    @@unique([stashPath])
}

model SceneRating {
    id          Int         @id @default(autoincrement())
    userId      Int
    sceneId     String      // Stash scene ID
    rating      Int?        // 0-100, null if not rated
    favorite    Boolean     @default(false)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, sceneId])
    @@index([userId])
    @@index([sceneId])
    @@index([favorite])
    @@index([rating])
}

model PerformerRating {
    id          Int         @id @default(autoincrement())
    userId      Int
    performerId String      // Stash performer ID
    rating      Int?        // 0-100, null if not rated
    favorite    Boolean     @default(false)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, performerId])
    @@index([userId])
    @@index([performerId])
    @@index([favorite])
    @@index([rating])
}

model StudioRating {
    id          Int         @id @default(autoincrement())
    userId      Int
    studioId    String      // Stash studio ID
    rating      Int?        // 0-100, null if not rated
    favorite    Boolean     @default(false)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, studioId])
    @@index([userId])
    @@index([studioId])
    @@index([favorite])
    @@index([rating])
}

model TagRating {
    id          Int         @id @default(autoincrement())
    userId      Int
    tagId       String      // Stash tag ID
    rating      Int?        // 0-100, null if not rated
    favorite    Boolean     @default(false)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, tagId])
    @@index([userId])
    @@index([tagId])
    @@index([favorite])
    @@index([rating])
}

model GalleryRating {
    id          Int         @id @default(autoincrement())
    userId      Int
    galleryId   String      // Stash gallery ID
    rating      Int?        // 0-100, null if not rated
    favorite    Boolean     @default(false)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, galleryId])
    @@index([userId])
    @@index([galleryId])
    @@index([favorite])
    @@index([rating])
}

model GroupRating {
    id          Int         @id @default(autoincrement())
    userId      Int
    groupId     String      // Stash group ID
    rating      Int?        // 0-100, null if not rated
    favorite    Boolean     @default(false)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, groupId])
    @@index([userId])
    @@index([groupId])
    @@index([favorite])
    @@index([rating])
}

model UserContentRestriction {
    id            Int      @id @default(autoincrement())
    userId        Int
    entityType    String   // 'groups' | 'tags' | 'studios' | 'galleries'
    mode          String   // 'INCLUDE' | 'EXCLUDE'
    entityIds     String   // JSON array of entity IDs (stringified)
    restrictEmpty Boolean  @default(false)  // If true, restrict items with no entities of this type
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, entityType])
    @@index([userId])
}

// Performance optimization: Pre-computed per-user statistics
// These tables cache aggregated stats from watch history to avoid expensive real-time calculations

model UserPerformerStats {
    id              Int       @id @default(autoincrement())
    userId          Int
    performerId     String    // Stash performer ID

    // Aggregated statistics from all scenes featuring this performer
    oCounter        Int       @default(0)      // Total O counter increments
    playCount       Int       @default(0)      // Total play count
    lastPlayedAt    DateTime?                  // Most recent playback timestamp
    lastOAt         DateTime?                  // Most recent O timestamp

    updatedAt       DateTime  @updatedAt

    @@unique([userId, performerId])
    @@index([userId])
    @@index([performerId])
}

model UserStudioStats {
    id              Int       @id @default(autoincrement())
    userId          Int
    studioId        String    // Stash studio ID

    // Aggregated statistics from all scenes produced by this studio
    oCounter        Int       @default(0)      // Total O counter increments
    playCount       Int       @default(0)      // Total play count

    updatedAt       DateTime  @updatedAt

    @@unique([userId, studioId])
    @@index([userId])
    @@index([studioId])
}

model UserTagStats {
    id              Int       @id @default(autoincrement())
    userId          Int
    tagId           String    // Stash tag ID

    // Aggregated statistics from all scenes tagged with this tag
    oCounter        Int       @default(0)      // Total O counter increments
    playCount       Int       @default(0)      // Total play count

    updatedAt       DateTime  @updatedAt

    @@unique([userId, tagId])
    @@index([userId])
    @@index([tagId])
}

enum UserRole {
    ADMIN
    USER
}

// Track which data migrations have been applied
model DataMigration {
    id          Int      @id @default(autoincrement())
    name        String   @unique  // Migration identifier (e.g., "001_rebuild_user_stats")
    appliedAt   DateTime @default(now())
}
